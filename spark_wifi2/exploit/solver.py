from struct import unpack_from
from scapy.all import *

class DUMLPacket:
    def __init__(self, packet):        
        self.packet = packet
        self.parse_header()
        self.parse_transit()
        self.parse_command()
        self.parse_payload_crc()

    def parse_header(self):
        self.magic = self.packet[0]
        self.length = self.packet[1] | ((self.packet[2] & 0x03) << 8)
        self.version = self.packet[2] >> 2
        self.crc8 = self.packet[3]

        assert self.magic == 0x55, "Invalid magic byte"
        assert self.length == len(self.packet), "Invalid length"

    def parse_transit(self):
        self.src_id = (self.packet[4] & 0xe0) >> 5
        self.src_type = self.packet[4] & 0x1F
        self.dest_id = (self.packet[5] & 0xe0) >> 5
        self.dest_type = self.packet[5] & 0x1F
        self.counter = ((self.packet[7] & 0xFF) << 8) | (self.packet[6] & 0xFF)

    def parse_command(self):
        self.cmd_type = self.packet[8] >> 7
        self.ack_type = (self.packet[8] >> 5) & 0x03
        self.encrypt = self.packet[8] & 0x07
        self.cmd_set = self.packet[9]
        self.cmd_id = self.packet[10]

    def parse_payload_crc(self):
        self.payload = self.packet[11:-2]
        #print(self.payload)
        self.crc16 = (self.packet[-2], self.packet[-1]) 

    def dump_packet(self):
        global g_idx
        open("dumls/%d.bin"%(g_idx), "wb").write(self.packet)
        g_idx += 1
        
    def __str__(self):
        return f"DUMLPacket: SrcID={self.src_id}, SrcType={self.src_type}, DestID={self.dest_id}, DestType={self.dest_type}, CmdSet={self.cmd_set}, CmdID={self.cmd_id}"

    
class DJIUDPPacket:
    def __init__(self, data):
        self.data = data
        self.parse_header()

    def parse_header(self):
        (packet_length, session_id, sequence_number, packet_type, xor_value) = unpack_from('<HHHBB', self.data)
        self.packet_length = packet_length & 0x7FFF 
        self.session_id = session_id
        self.sequence_number = sequence_number
        self.packet_type = packet_type
        self.xor_value = xor_value
        

class HandshakePacket(DJIUDPPacket):
    def __init__(self, data):
        super().__init__(data)
        self.seed = unpack_from('<H', self.data, 8)[0]

        print("HandShake!")

class TelemetryPacket(DJIUDPPacket):
    def __init__(self, data):
        super().__init__(data)
        self.parse_telemetry()

    def parse_telemetry(self):
        (self.type2_send_window_start, self.type2_send_window_end, self.type2_resend_state1, self.type2_resend_state2,
         self.type3_send_window_start, self.type3_send_window_end, self.type3_resend_state1, self.type3_resend_state2,
         self.type5_receive_window_start, self.type5_receive_window_end) = unpack_from('<HHHHHHHHHH', self.data, 8)

        self.type5_resend_request_list_length = unpack_from('<H', self.data, 26)[0]
        self.mb_payload_length = unpack_from('<H', self.data, 28 + self.type5_resend_request_list_length)[0]
        self.mb_payload = self.data[30 + self.type5_resend_request_list_length:]

class VideoFeedPacket(DJIUDPPacket):
    def __init__(self, data):
        super().__init__(data)
        self.frame_number, self.part_info, self.part_number = unpack_from('<BHB', self.data, 16)
        self.video_content = self.data[20:]  
        self.parse_video_feed()

    def parse_video_feed(self):
        f_video.write(self.video_content)
            

class CommandAcknowledgePacket(DJIUDPPacket):
    def __init__(self, data):
        super().__init__(data)
        self.parse_command_ack()

    def parse_command_ack(self):
        (self.type2_receive_window_start, self.type2_receive_window_end) = unpack_from('<HH', self.data, 8)

        ### WARNING : Unknown
        self.N = 1
        
        offset = 14 + 2 *self.N
        
        (self.type3_receive_window_start, self.type3_receive_window_end) = unpack_from('<HH', self.data, offset)
        offset += 6 + 2 * self.N

        (self.type5_send_window_start, self.type5_send_window_end,
         self.type5_resend_state1, self.type5_resend_state2) = unpack_from('<HHHH', self.data, offset)
        
        self.mb_payload_length = unpack_from('<H', self.data, offset + 8)[0]
        self.mb_payload = self.data[offset + 10:]

        ### FIX ME : There may be multiple DUML Packet
        self.payload = DUMLPacket(self.mb_payload)
        self.payload.dump_packet()

class CommandDataPacket(DJIUDPPacket):
    def __init__(self, data):
        super().__init__(data)
        self.parse_command_data()

    def parse_command_data(self):
        (self.type5_send_window_start, self.type5_send_window_end, self.type5_resend_state1, self.type5_resend_state2) = unpack_from('<HHHH', self.data, 8)
        
        self.payload = DUMLPacket(self.data[0x14:])
        self.payload.dump_packet()

def parse_packet(data):
    packet_type = data[6]
    
    # print(cnt, packet_type)
    if packet_type == 0x00:
        return HandshakePacket(data)
    elif packet_type == 0x01 or packet_type == 0x03:
        return TelemetryPacket(data)
    elif packet_type == 0x02:
        return VideoFeedPacket(data)
    elif packet_type == 0x04 or packet_type == 0x06:
        return CommandAcknowledgePacket(data)
    elif packet_type == 0x05:
        return CommandDataPacket(data)
    else:
        return DJIUDPPacket(data)


g_idx = 0
filename = "cracked_udp"
f_video = open(f"{filename}.h264", "wb")
packets = rdpcap(f"{filename}.pcap")
cnt = -1
for packet in packets:
    cnt += 1
    if IP in packet:
        ip = packet[IP]
        if UDP in packet:
            udp = packet[UDP]
            try:
                parse_packet(udp.payload.load)
            except Exception as e:
                pass

f_video.close()
